<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <title>Ponza Health - Início</title>
  <link rel="icon" href="{{ url_for('static', filename='images/favicon.ico') }}">
  <link href="https://fonts.googleapis.com/css2?family=Funnel+Sans:wght@300;400;500;600;700&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

  <style>
    :root {
      --bg: #ffffff;
      --surface: #ffffff;
      --surface-alt: #f8fafc;
      --border: #e5e7eb;
      --ink: #0b1220;
      --ink-dim: #475569;
      --brand-grad: linear-gradient(180deg, #131d35 0%, #0f182b 100%);
      --brand-blue-solid: #0f182b;
      --shadow: 0 8px 20px rgba(2, 6, 23, .06);
      --shadow-strong: 0 14px 36px rgba(2, 6, 23, .12);
    }

    .gtooltip {
      padding: 8px 10px;
      background: #fff;
      color: var(--ink);
      border: 1px solid var(--brand-blue-solid);
      border-radius: 8px;
      box-shadow: var(--shadow);
      font-family: 'Funnel Sans', sans-serif;
      font-size: 14px
    }

    .gtooltip b {
      color: var(--ink)
    }

    @keyframes chartSlideIn {
      from {
        opacity: 0;
        transform: translateY(30px)
      }

      to {
        opacity: 1;
        transform: translateY(0)
      }
    }

    * {
      box-sizing: border-box
    }

    html,
    body {
      margin: 0
    }

    body {
      display: flex;
      min-height: 100vh;
      font-family: 'Funnel Sans', sans-serif;
      background: var(--bg);
      color: var(--ink)
    }

    body.modal-open {
      overflow: hidden
    }

    /* SIDEBAR (igual) */
    .sidebar {
      width: 250px;
      min-height: 100vh;
      background: var(--brand-grad);
      padding: 28px 18px;
      border-right: 1px solid #1f2937;
      box-shadow: 2px 0 14px rgba(0, 0, 0, .18);
      display: flex;
      flex-direction: column;
      transition: width 180ms ease;
      position: sticky;
      top: 0
    }

    .sidebar-logo {
      width: 200px;
      display: block;
      margin: 0 auto 18px;
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, .25));
      transition: width 180ms ease, margin 180ms ease
    }

    .sidebar a.menu-item {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 16px;
      padding: 14px 16px;
      border-radius: 10px;
      color: #e5e7eb;
      text-decoration: none;
      margin-bottom: 18px;
      font-weight: 600;
      transition: background .2s, color .2s, transform .12s
    }

    .sidebar a.menu-item i {
      width: 21px;
      text-align: center;
      flex: 0 0 21px
    }

    .sidebar a.menu-item:hover {
      background: #fff;
      color: var(--brand-blue-solid);
      transform: translateX(4px)
    }

    .sidebar a.menu-item:hover i {
      color: var(--brand-blue-solid)
    }

    .sidebar a.menu-item.active {
      color: #fff;
      background: var(--brand-grad);
      box-shadow: 0 10px 26px rgba(0, 0, 0, .25)
    }

    .sidebar-spacer {
      flex: 1 1 auto
    }

    .sidebar a.menu-item.logout {
      color: #e5e7eb
    }

    .sidebar-toggle {
      align-self: flex-end;
      background: rgba(255, 255, 255, .10);
      border: 1px solid rgba(255, 255, 255, .25);
      color: #e5e7eb;
      padding: 6px 10px;
      border-radius: 10px;
      cursor: pointer;
      margin-bottom: 14px;
      transition: background .2s, border-color .2s, transform .12s;
      font-size: 12px
    }

    .sidebar-toggle:hover {
      background: #fff;
      color: var(--brand-blue-solid);
      border-color: #fff;
      transform: translateY(-1px)
    }

    .sidebar.is-collapsed {
      width: 76px
    }

    .sidebar.is-collapsed .sidebar-logo {
      width: 44px;
      margin: 0 auto 22px
    }

    .sidebar.is-collapsed .menu-item {
      justify-content: center;
      gap: 0;
      padding: 12px 0;
      margin-bottom: 18px
    }

    .sidebar.is-collapsed .menu-item .label {
      display: none
    }

    .sidebar.is-collapsed .sidebar-toggle i {
      transform: rotate(180deg)
    }

    /* CONTEÚDO */
    .content {
      flex-grow: 1;
      padding: 40px;
      position: relative;
      min-width: 0;
      background: var(--bg);
      transition: padding 180ms ease
    }

    h2 {
      font-size: 34px;
      font-weight: 800;
      text-align: center;
      color: var(--ink);
      margin: 0 0 30px;
      position: relative
    }

    h2::after {
      content: '';
      position: absolute;
      bottom: -10px;
      left: 50%;
      transform: translateX(-50%);
      width: 80px;
      height: 4px;
      background: var(--brand-grad);
      border-radius: 2px;
      box-shadow: 0 0 8px rgba(0, 0, 0, .12)
    }

    /* NOVO: grade centralizada para os 4 cards */
    .donuts-grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(260px, 1fr));
      gap: 16px;
      justify-items: center;
      align-items: stretch;
      margin: 32px auto;
      max-width: 1200px;
    }

    @media(max-width:1200px) {
      .donuts-grid {
        grid-template-columns: repeat(2, minmax(260px, 1fr));
        max-width: 820px
      }
    }

    @media(max-width:620px) {
      .donuts-grid {
        grid-template-columns: 1fr;
        max-width: 420px
      }
    }

    .compact-card {
      background: var(--surface);
      border: 1px solid var(--border);
      padding: 14px;
      border-radius: 16px;
      box-shadow: var(--shadow);
      min-width: 260px;
      max-width: 280px;
      transition: transform .2s ease, box-shadow .2s ease;
      animation: chartSlideIn .6s ease-out;
      text-align: center;
    }

    .compact-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 28px rgba(2, 6, 23, .10)
    }

    .compact-card h3 {
      color: var(--brand-blue-solid);
      font-weight: 700;
      font-size: 15px;
      margin: 0 0 10px;
      text-align: center
    }

    .metric-row {
      display: flex;
      align-items: center;
      gap: 12px;
      justify-content: center
    }

    .mini-donut {
      margin: 0 auto
    }

    .metric-value {
      font-size: 24px;
      font-weight: 900;
      color: var(--ink);
      margin: 2px 0
    }

    .metric-label {
      font-size: 13px;
      color: var(--ink-dim);
      display: flex;
      align-items: center;
      gap: 6px;
      justify-content: center
    }

    .status-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--brand-blue-solid)
    }

    .status-indicator.new {
      background: #10b981
    }

    .status-indicator.return {
      background: #f59e0b
    }

    .status-indicator.particular {
      background: #3b82f6
    }

    .status-indicator.convenio {
      background: #8b5cf6
    }

    .link-plain {
      font-size: 4px;
      background: none;
      border: none;
      padding: 0;
      margin-top: 6px;
      font: inherit;
      color: var(--brand-blue-solid);
      cursor: pointer;
      text-decoration: underline;
      font-weight: 800
    }

    .link-plain:hover {
      filter: saturate(1.1)
    }

    /* BLOCO INFERIOR */
    .bottom-grid {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 16px
    }

    @media(max-width:1100px) {
      .bottom-grid {
        grid-template-columns: 1fr
      }
    }

    .chart-container {
      background: var(--surface);
      border: 1px solid var(--border);
      padding: 24px;
      border-radius: 16px;
      box-shadow: var(--shadow);
      animation: chartSlideIn .6s ease-out;
      color: var(--ink)
    }

    .chart-container h3 {
      color: var(--ink);
      font-weight: 800;
      font-size: 18px;
      margin: 0 0 16px;
      text-align: center;
      position: relative
    }

    .chart-container h3::after {
      content: '';
      position: absolute;
      bottom: -8px;
      left: 50%;
      transform: translateX(-50%);
      width: 50px;
      height: 3px;
      background: var(--brand-grad);
      border-radius: 2px
    }

    .side-widgets {
      display: flex;
      flex-direction: column;
      gap: 16px
    }

    .widget {
      background: var(--surface);
      border: 1px solid var(--border);
      padding: 16px;
      border-radius: 16px;
      box-shadow: var(--shadow)
    }

    .widget h4 {
      margin: 0 0 12px;
      font-size: 16px;
      font-weight: 800;
      color: var(--ink);
      text-align: center
    }

    .table-wrap {
      overflow: auto;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: #fff
    }

    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      font-size: 14px;
      color: var(--ink)
    }

    thead th {
      position: sticky;
      top: 0;
      background: var(--surface-alt);
      border-bottom: 1px solid var(--border);
      text-align: left;
      padding: 10px 12px;
      font-weight: 800;
      color: var(--ink)
    }

    tbody td {
      padding: 10px 12px;
      border-bottom: 1px solid var(--border)
    }

    tbody tr:hover {
      background: #f9fbff
    }

    /* TOP RIGHT */
    .top-profile {
      position: fixed;
      top: 18px;
      right: 28px;
      z-index: 1001;
      display: flex;
      align-items: center;
      gap: 12px;
      background: transparent;
      box-shadow: none
    }

    .icon-btn {
      position: relative;
      border: 1px solid var(--border);
      background: var(--surface);
      width: 44px;
      height: 44px;
      border-radius: 12px;
      cursor: pointer;
      display: grid;
      place-items: center;
      box-shadow: var(--shadow);
      transition: transform .15s ease, box-shadow .15s ease, border-color .15s;
      text-decoration: none
    }

    .icon-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 24px rgba(0, 0, 0, .12);
      border-color: var(--brand-blue-solid)
    }

    .icon-btn i {
      color: var(--brand-blue-solid);
      font-size: 18px
    }

    .icon-btn .badge {
      position: absolute;
      top: 6px;
      right: 6px;
      min-width: 16px;
      height: 16px;
      padding: 0 4px;
      border-radius: 999px;
      background: var(--brand-blue-solid);
      color: #fff;
      font-size: 10px;
      font-weight: 800;
      display: flex;
      align-items: center;
      justify-content: center
    }

    /* Modal Detalhes */
    #detailsModal {
      display: none;
      position: fixed;
      inset: 0;
      z-index: 9999;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, .55);
      backdrop-filter: blur(4px);
      padding: 20px
    }

    #detailsModal .modal-card {
      width: 100%;
      max-width: 420px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      box-shadow: 0 25px 60px rgba(0, 0, 0, .20);
      color: var(--ink);
      padding: 30px;
      position: relative;
      text-align: center
    }

    #detailsModal h3 {
      margin: 0 0 12px;
      font-size: 20px;
      font-weight: 800;
      color: var(--ink)
    }

    #detailsModal .stats {
      background: var(--surface-alt);
      border: 1px solid var(--brand-blue-solid);
      padding: 18px;
      border-radius: 14px;
      margin: 18px 0;
      text-align: left
    }

    #detailsModal .stats p {
      margin: 8px 0;
      color: var(--ink-dim);
      font-weight: 700
    }

    #detailsModal .stats strong {
      color: var(--ink)
    }

    #detailsModal .close-btn {
      position: absolute;
      top: 10px;
      right: 12px;
      background: none;
      border: none;
      color: #64748b;
      font-size: 24px;
      font-weight: 800;
      cursor: pointer;
      transition: transform .2s, color .2s
    }

    #detailsModal .close-btn:hover {
      color: var(--brand-blue-solid);
      transform: scale(1.1)
    }

    /* novo gráfico compacto */
    .mini-line {
      width: 100%;
      height: 90px;
      margin: 0 auto;
    }

    @media(max-width:700px) {
      .top-profile {
        right: 10px;
        top: 8px
      }

      .content {
        padding: 28px
      }

      .sidebar {
        width: 72px
      }
    }
  </style>
</head>

<body>
  <div class="top-profile" aria-label="Ações do usuário">
    <a href="{{ url_for('account') }}" class="icon-btn" title="Minha conta" aria-label="Minha conta"><i
        class="fa fa-user"></i></a>
    <button class="icon-btn" type="button" title="Notificações" aria-label="Notificações">
      <i class="fa fa-bell"></i><span class="badge">{{ (notifications_unread or 0) }}</span>
    </button>
  </div>

  <div id="detailsModal" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal-card">
      <button class="close-btn" data-close onclick="closeModal()" aria-label="Fechar">×</button>
      <h3>Detalhes do Pacote</h3>
      <div class="stats">
        <p><strong>Pacotes Totais:</strong> {{ (package_limit or 0) }}</p>
        <p><strong>Usadas:</strong> <span style="color:var(--brand-blue-solid);">{{ (package_used or 0) }}</span></p>
        <p><strong>Disponíveis:</strong> <span style="color:var(--brand-blue-solid);">{{ (remaining or 0) }}</span></p>
      </div>
      <div class="card-actions">
        <button type="button" class="link-plain" onclick="window.location.href='{{ url_for('purchase') }}'">Comprar
          Pacotes</button>
      </div>
    </div>
  </div>

  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <button class="sidebar-toggle" onclick="toggleSidebar()" aria-label="Minimizar/Maximizar menu"><i
        class="fa fa-angle-double-left"></i></button> <img src="{{ url_for('static', filename='images/3.svg') }}"
      class="sidebar-logo" alt="Ponza Health" />
    <a href="{{ url_for('index') }}" class="menu-item"><i class="fa fa-home"></i><span class="label">Início</span></a>
    <a href="{{ url_for('upload') }}" class="menu-item"><i class="fa fa-upload"></i><span class="label">Ponza
        Lab</span></a>
    <a href="{{ url_for('quote_index') }}" class="menu-item"><i class="fa fa-file-text-o"></i><span
        class="label">Cotações</span></a>

    <a href="{{ url_for('catalog') }}" class="menu-item"><i class="fa fa-users"></i><span
        class="label">Pacientes</span></a>
    <a href="{{ url_for('products') }}" class="menu-item"><i class="fa fa-archive"></i><span
        class="label">Estoque</span></a>
    <a href="{{ url_for('agenda') }}" class="menu-item"><i class="fa fa-calendar"></i><span
        class="label">Agenda</span></a>

    <a href="{{ url_for('purchase') }}" class="menu-item"><i class="fa fa-credit-card"></i><span
        class="label">Pagamentos</span></a>
    <div class="sidebar-spacer"></div>
    {% if session.username and session.username|lower == 'admin' %}
    <a href="{{ url_for('admin_users') }}" class="menu-item">
      <i class="fa fa-shield"></i><span class="label">Admin</span>
    </a>
    {% endif %}

    <a href="{{ url_for('logout') }}" class="menu-item logout"><i class="fa fa-sign-out"></i><span
        class="label">Sair</span></a>
  </div>

  <div class="content">
    <h2>Bem-vindo(a) {{ username }}</h2>

    {% if trial_active %}
    <div style="
      background: #fff7ed;
      border: 1px solid #fdba74;
      color: #c2410c;
      padding: 14px 18px;
      border-radius: 12px;
      text-align: center;
      font-weight: 700;
      font-size: 16px;
      margin: 0 auto 24px;
      max-width: 900px;
      box-shadow: var(--shadow);
    ">
      Você está no <strong>período de teste</strong>.
      <a href="{{ url_for('payments') }}" style="color: #b91c1c; text-decoration: underline;">
        Faça a compra do serviço
      </a>
      para continuar com acesso após o fim do teste.
    </div>
    {% endif %}

    <!-- DONUTS + CONSULTAS -->
    <div class="donuts-grid">
      <div class="compact-card">
        <h3>Pacotes de Análise</h3>
        <div class="metric-row">
          <div id="packages_chart" class="mini-donut" style="width:64px;height:64px"></div>
          <div>
            <div class="metric-value">
              {{ ((used or 0) + (remaining or 0)) and ((used or 0) * 100 // ((used or 0) + (remaining or 0))) or 0 }}%
            </div>
            <div class="metric-label"><span class="status-indicator" style="background:var(--brand-blue-solid);"></span>
              Usado: {{ used or 0 }}</div>
            <div class="metric-label"><span class="status-indicator" style="background:#e5e7eb;"></span> Disponível: {{
              remaining or 0 }}</div>
          </div>
        </div>
        <div class="card-actions">
          <button class="link-plain" onclick="openModal()">Ver detalhes</button>
        </div>
      </div>

      <div class="compact-card">
        <h3>Pacientes (últimos 30 dias)</h3>
        <div class="metric-row">
          <div id="patients_chart" class="mini-donut" style="width:64px;height:64px"></div>
          <div>
            <div class="metric-value">{{ (patients_new_30 or 0) + (patients_return_30 or 0) }}</div>
            <div class="metric-label"><span class="status-indicator new"></span> Novos: {{ patients_new_30 or 0 }}</div>
            <div class="metric-label"><span class="status-indicator" style="background:#e5e7eb;"></span> Recorrentes: {{
              patients_return_30 or 0 }}</div>
          </div>
        </div>
      </div>

      <!-- Novo card de Consultas -->
      <div class="compact-card">
        <h3>Consultas (últimos 7 dias)</h3>
        <div id="consultations_chart" class="mini-line"></div>
      </div>

      <div class="compact-card">
        <h3>Pagamentos (últimos 30 dias)</h3>
        <div class="metric-row">
          <div id="insurance_chart" class="mini-donut" style="width:64px;height:64px"></div>
          <div>
            <div class="metric-value">{{ (insurance_particular_30 or 0) + (insurance_convenio_30 or 0) }}</div>
            <div class="metric-label"><span class="status-indicator particular"></span> Particular: {{
              insurance_particular_30 or 0 }}</div>
            <div class="metric-label"><span class="status-indicator convenio"></span> Convênio: {{ insurance_convenio_30
              or 0 }}</div>
          </div>
        </div>
      </div>
    </div>

    <!-- GRID INFERIOR -->
    <div class="bottom-grid">
      <div class="chart-container">
        <h3>Análises de PDFs — últimos 7 dias</h3>
        <div id="curve_chart" style="width:100%;height:300px"></div>
      </div>

      <div class="side-widgets">
        <div class="widget">
          <h4>Estoque baixo (&lt; 5)</h4>
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>Produto</th>
                  <th style="width:80px">Qtd.</th>
                </tr>
              </thead>
              <tbody>
                {% if low_stock and low_stock|length > 0 %}
                {% for p in low_stock %}
                <tr>
                  <td>{{ p.name }}</td>
                  <td>{{ p.quantity }}</td>
                </tr>
                {% endfor %}
                {% else %}
                <tr>
                  <td colspan="2" style="color:var(--ink-dim)">Nenhum produto abaixo do nível mínimo.</td>
                </tr>
                {% endif %}
              </tbody>
            </table>
          </div>
        </div>

        <!-- Substitui donut por TABELA de Cotações -->
        <div class="widget">
          <h4>Cotações respondidas</h4>
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>Cotação</th>
                  <th style="width:120px">Respostas</th>
                </tr>
              </thead>
              <tbody>
                {% if quotes_items and quotes_items|length > 0 %}
                {% for q in quotes_items %}
                <tr>
                  <td>{{ q.name or q.subject }}</td>
                  <td>{{ q.responses or 0 }}</td>
                </tr>
                {% endfor %}
                {% else %}
                <tr>
                  <td colspan="2" style="color:var(--ink-dim)">Nenhuma cotação encontrada.</td>
                </tr>
                {% endif %}
              </tbody>
            </table>
          </div>
          <div style="text-align:center;color:var(--ink-dim);font-weight:700;margin-top:8px">
            Total: {{ quotes_total or 0 }} — Respondidas: {{ quotes_responded or 0 }} — Pendentes: {{ quotes_pending or
            0 }}
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- SCRIPTS -->
  <!-- SCRIPTS -->
  <script>
    // ===== Variáveis vindas do backend =====
    const pacotes_usados = Number({{ used or 0 }}) || 0;
    const pacotes_comprados = Number({{ (used or 0) + (remaining or 0) }}) || 0;

    const PATIENTS_NEW_30 = Number({{ patients_new_30 or 0 }}) || 0;
    const PATIENTS_RETURN_30 = Number({{ patients_return_30 or 0 }}) || 0;
    const INS_PARTICULAR_30 = Number({{ insurance_particular_30 or 0 }}) || 0;
    const INS_CONVENIO_30 = Number({{ insurance_convenio_30 or 0 }}) || 0;

    // Consultas últimos 7 dias (par [label, valor])
    const CONSULTATIONS_7 = [
      {% if consultations_last7 is defined and consultations_last7 %}
    {% for item in consultations_last7 %}
    ['{{ item.date }}', Number({{ item.count or 0 }})]{% if not loop.last %}, {% endif %}
    {% endfor %}
    {% endif %}
  ];

    // Análises de PDFs últimos 7 dias (tente vários nomes comuns do backend)
    const PDF_ANALYSES_7 = [
      {% if pdf_analyses_last7 is defined and pdf_analyses_last7 %}
    {% for item in pdf_analyses_last7 %}
    ['{{ item.date }}', Number({{ item.count or 0 }})]{% if not loop.last %}, {% endif %}
    {% endfor %}
    {% elif analyses_last7 is defined and analyses_last7 %}
    {% for item in analyses_last7 %}
    ['{{ item.date }}', Number({{ item.count or 0 }})]{% if not loop.last %}, {% endif %}
    {% endfor %}
    {% elif pdfs_last7 is defined and pdfs_last7 %}
    {% for item in pdfs_last7 %}
    ['{{ item.date }}', Number({{ item.count or 0 }})]{% if not loop.last %}, {% endif %}
    {% endfor %}
    {% endif %}
  ];

    // ===== Google Charts =====
    google.charts.load('current', { packages: ['corechart'] });
    google.charts.setOnLoadCallback(initCharts);

    let packagesChart, patientsChart, insuranceChart;
    let consultationsChart, curveChart; // barras
    let packagesData, patientsData, insuranceData, consultationsData, curveData;

    // Helpers
    function zeroSafePieData(pairs, fallbackLabel = 'Sem dados') {
      const total = pairs.reduce((s, p) => s + (Number(p[1]) || 0), 0);
      if (total > 0) {
        return { data: google.visualization.arrayToDataTable([['Tipo', 'Qtd'], ...pairs]) };
      }
      return { data: google.visualization.arrayToDataTable([['Tipo', 'Qtd'], [fallbackLabel, 1]]) };
    }

    function brDate(d) {
      const dd = String(d.getDate()).padStart(2, '0');
      const mm = String(d.getMonth() + 1).padStart(2, '0');
      const yyyy = d.getFullYear();
      return `${dd}/${mm}/${yyyy}`;
    }

    // Garante 7 pontos (últimos 7 dias) caso o backend não mande nada
    function ensure7DaySeries(rows) {
      if (Array.isArray(rows) && rows.length > 0) return rows;
      const out = [];
      for (let i = 6; i >= 0; i--) {
        const d = new Date();
        d.setDate(d.getDate() - i);
        out.push([brDate(d), 0]);
      }
      return out;
    }

    function getSmallDonutOptions() {
      return {
        backgroundColor: 'transparent',
        pieHole: .65,
        pieSliceText: 'none',
        legend: 'none',
        chartArea: { width: '100%', height: '100%' },
        tooltip: { trigger: 'none' }
      };
    }

    function getMiniBarOptions() {
      return {
        backgroundColor: 'transparent',
        chartArea: { left: 24, top: 10, width: '82%', height: '70%' },
        hAxis: { textStyle: { fontSize: 10, color: '#475569' }, gridlines: { color: 'transparent' } },
        vAxis: { minValue: 0, textStyle: { fontSize: 10, color: '#475569' }, gridlines: { color: '#e2e8f0' } },
        legend: 'none',
        bar: { groupWidth: '65%' },
        colors: ['#0f182b']
      };
    }

    function getMainBarOptions() {
      return {
        backgroundColor: 'transparent',
        chartArea: { left: 40, top: 24, width: '85%', height: '70%' },
        hAxis: { textStyle: { fontSize: 12, color: '#475569' } },
        vAxis: { minValue: 0, textStyle: { fontSize: 12, color: '#475569' }, gridlines: { color: '#e2e8f0' } },
        legend: 'none',
        bar: { groupWidth: '60%' },
        colors: ['#0f182b']
      };
    }

    function initCharts() {
      // Donuts
      const total = Math.max(pacotes_comprados, 0);
      const usados = Math.max(Math.min(pacotes_usados, total), 0);
      const disponivel = Math.max(total - usados, 0);
      packagesData = zeroSafePieData([['Usado', usados], ['Disponível', disponivel]], 'Sem pacotes').data;
      patientsData = zeroSafePieData([['Novos', PATIENTS_NEW_30], ['Recorrentes', PATIENTS_RETURN_30]], 'Sem pacientes').data;
      insuranceData = zeroSafePieData([['Particular', INS_PARTICULAR_30], ['Convênio', INS_CONVENIO_30]], 'Sem atendimentos').data;

      packagesChart = new google.visualization.PieChart(document.getElementById('packages_chart'));
      patientsChart = new google.visualization.PieChart(document.getElementById('patients_chart'));
      insuranceChart = new google.visualization.PieChart(document.getElementById('insurance_chart'));

      // Barras - Consultas (mini)
      const consPairs = ensure7DaySeries(CONSULTATIONS_7);
      consultationsData = new google.visualization.DataTable();
      consultationsData.addColumn('string', 'Dia');
      consultationsData.addColumn('number', 'Consultas');
      consultationsData.addRows(consPairs);
      consultationsChart = new google.visualization.ColumnChart(document.getElementById('consultations_chart'));

      // Barras - Análises de PDFs (principal)
      const pdfPairs = ensure7DaySeries(PDF_ANALYSES_7);
      curveData = new google.visualization.DataTable();
      curveData.addColumn('string', 'Dia');
      curveData.addColumn('number', 'Análises');
      curveData.addRows(pdfPairs);
      curveChart = new google.visualization.ColumnChart(document.getElementById('curve_chart'));

      redrawCharts();
      window.addEventListener('resize', redrawCharts);
    }

    function redrawCharts() {
      if (packagesChart) packagesChart.draw(packagesData, getSmallDonutOptions());
      if (patientsChart) patientsChart.draw(patientsData, getSmallDonutOptions());
      if (insuranceChart) insuranceChart.draw(insuranceData, getSmallDonutOptions());

      if (consultationsChart) consultationsChart.draw(consultationsData, getMiniBarOptions());
      if (curveChart) curveChart.draw(curveData, getMainBarOptions());
    }

    // ===== Modal =====
    function openModal() {
      const m = document.getElementById('detailsModal');
      m.style.display = 'flex';
      document.body.classList.add('modal-open');
      m.setAttribute('aria-hidden', 'false');
      m.querySelector('[data-close]')?.focus();
    }
    function closeModal() {
      const m = document.getElementById('detailsModal');
      m.style.display = 'none';
      document.body.classList.remove('modal-open');
      m.setAttribute('aria-hidden', 'true');
    }
    document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });

    // ===== Sidebar =====
    function toggleSidebar() {
      const sidebar = document.querySelector('.sidebar');
      const body = document.body;
      sidebar.classList.toggle('is-collapsed');
      const collapsed = sidebar.classList.contains('is-collapsed');
      body.classList.toggle('sidebar-collapsed', collapsed);
      localStorage.setItem('sidebarCollapsed', collapsed ? '1' : '0');
    }
    document.addEventListener('DOMContentLoaded', () => {
      const collapsed = localStorage.getItem('sidebarCollapsed') === '1';
      if (collapsed) {
        document.querySelector('.sidebar')?.classList.add('is-collapsed');
        document.body.classList.add('sidebar-collapsed');
      }
    });
  </script>
</body>

</html>