<!DOCTYPE html>
<html lang="pt-br">

<head>
	<meta charset="UTF-8">
	<title>Agenda - Ponza Health</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="icon" href="{{ url_for('static', filename='images/favicon.ico') }}" type="image/x-icon">
	<link href="https://fonts.googleapis.com/css2?family=Funnel+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css">
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
	<style>
		:root {
			--brand-900: #0b1220;
			--brand-800: #131d35;
			--brand-700: #1d2d4d;
			--brand-500: #2f4da5;
			--brand-muted: #6b7280;
			--accent-blue: #2563eb;
			--accent-green: #22c55e;
			--accent-purple: #7c3aed;
			--accent-orange: #f97316;
			--accent-rose: #f43f5e;
			--bg: #f5f7fb;
			--surface: #ffffff;
			--surface-alt: #f1f5f9;
			--border: #e2e8f0;
			--radius-lg: 22px;
			--radius-md: 14px;
			--shadow-soft: 0 22px 60px rgba(15, 23, 42, 0.08);
			--shadow-card: 0 18px 36px rgba(15, 23, 42, 0.07);
			--font-family: 'Funnel Sans', system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial, sans-serif;
		}

		* {
			box-sizing: border-box;
		}

		html,
		body {
			margin: 0;
			padding: 0;
			height: 100%;
		}

		body {
			min-height: 100vh;
			display: flex;
			font-family: var(--font-family);
			background: var(--bg);
			color: var(--brand-900);
		}

		a {
			color: inherit;
			text-decoration: none;
		}

		button {
			font-family: inherit;
		}

		/* Top profile */
		.top-profile {
			position: fixed;
			top: 18px;
			right: 28px;
			z-index: 1001;
			display: flex;
			align-items: center;
			gap: 12px;
		}

		.icon-btn {
			position: relative;
			border: 1px solid var(--border);
			background: var(--surface);
			width: 44px;
			height: 44px;
			border-radius: 12px;
			cursor: pointer;
			display: grid;
			place-items: center;
			box-shadow: var(--shadow-card);
			transition: transform 0.15s ease, box-shadow 0.15s ease, border-color 0.15s ease;
		}

		.icon-btn:hover {
			transform: translateY(-1px);
			box-shadow: 0 14px 28px rgba(2, 6, 23, 0.16);
			border-color: var(--brand-800);
		}

		.icon-btn i {
			color: var(--brand-800);
			font-size: 18px;
		}

		.icon-btn .badge {
			position: absolute;
			top: 6px;
			right: 6px;
			min-width: 16px;
			height: 16px;
			padding: 0 4px;
			border-radius: 999px;
			background: var(--accent-rose);
			color: #fff;
			font-size: 10px;
			font-weight: 800;
			display: flex;
			align-items: center;
			justify-content: center;
		}

		/* Sidebar */
		.sidebar {
			width: 250px;
			min-height: 100vh;
			background: linear-gradient(180deg, #111b33 0%, #0b1220 100%);
			padding: 28px 18px;
			border-right: 1px solid rgba(255, 255, 255, 0.08);
			box-shadow: 2px 0 18px rgba(10, 20, 40, 0.28);
			display: flex;
			flex-direction: column;
			position: sticky;
			top: 0;
		}

		.sidebar-toggle {
			align-self: flex-end;
			background: rgba(255, 255, 255, 0.12);
			border: 1px solid rgba(255, 255, 255, 0.25);
			color: #e5e7eb;
			padding: 6px 10px;
			border-radius: 10px;
			cursor: pointer;
			margin-bottom: 14px;
			transition: background 0.2s, border-color 0.2s, transform 0.12s;
			font-size: 12px;
		}

		.sidebar-toggle:hover {
			background: #fff;
			color: var(--brand-800);
			border-color: #fff;
			transform: translateY(-1px);
		}

		.sidebar-logo {
			width: 200px;
			display: block;
			margin: 0 auto 18px;
			filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.25));
			transition: width 0.18s ease, margin 0.18s ease;
		}

		.sidebar a.menu-item {
			display: flex;
			align-items: center;
			gap: 12px;
			font-size: 16px;
			padding: 14px 16px;
			border-radius: 10px;
			color: #e5e7eb;
			text-decoration: none;
			margin-bottom: 18px;
			font-weight: 600;
			transition: background 0.2s, color 0.2s, transform 0.12s;
		}

		.sidebar a.menu-item i {
			width: 21px;
			text-align: center;
			flex: 0 0 21px;
		}

		.sidebar a.menu-item:hover {
			background: rgba(255, 255, 255, 0.18);
			color: #fff;
			transform: translateX(4px);
		}

		.sidebar a.menu-item.active {
			color: #fff;
			background: rgba(255, 255, 255, 0.16);
			box-shadow: 0 16px 38px rgba(8, 20, 40, 0.28);
		}

		.sidebar-spacer {
			flex: 1 1 auto;
		}

		.sidebar a.menu-item.logout {
			color: #e5e7eb;
		}

		.sidebar.is-collapsed {
			width: 76px;
		}

		.sidebar.is-collapsed .sidebar-logo {
			width: 44px;
			margin: 0 auto 22px;
		}

		.sidebar.is-collapsed .menu-item {
			justify-content: center;
			gap: 0;
			padding: 12px 0;
			margin-bottom: 14px;
		}

		.sidebar.is-collapsed .menu-item .label {
			display: none;
		}

		.sidebar.is-collapsed .sidebar-toggle i {
			transform: rotate(180deg);
		}

		/* Main content */
		.content {
			flex: 1;
			padding: 42px 54px;
			min-width: 0;
			overflow-y: auto;
		}

		.main-shell {
			max-width: 1320px;
			margin: 0 auto;
			display: flex;
			flex-direction: column;
			gap: 32px;
		}

		.page-hero {
			background: var(--surface);
			border: 1px solid var(--border);
			border-radius: var(--radius-lg);
			box-shadow: var(--shadow-soft);
			padding: 32px;
			display: grid;
			grid-template-columns: minmax(0, 1.5fr) minmax(280px, 1fr);
			gap: 28px;
			align-items: flex-start;
		}

		.page-hero__main {
			display: flex;
			flex-direction: column;
			gap: 24px;
		}

		.page-hero__text {
			max-width: 560px;
		}

		.page-hero__insights {
			display: flex;
			flex-direction: column;
			gap: 16px;
			max-width: 340px;
		}

		.hero-card {
			padding: 20px;
		}

		.hero-card .panel-header {
			margin-bottom: 14px;
		}

		.hero-card.highlight-card .panel-text {
			margin-bottom: 18px;
		}

		.page-hero__text .eyebrow {
			display: inline-flex;
			align-items: center;
			gap: 8px;
			text-transform: uppercase;
			font-size: 12px;
			letter-spacing: 0.3em;
			font-weight: 800;
			color: var(--brand-muted);
		}

		.page-hero__text h1 {
			margin: 12px 0 8px;
			font-size: 34px;
			line-height: 1.2;
			color: var(--brand-800);
		}

		.page-hero__text p {
			margin: 0;
			color: var(--brand-muted);
			font-size: 15px;
			max-width: 520px;
		}

		.page-hero__actions {
			display: flex;
			align-items: center;
			gap: 12px;
			flex-wrap: wrap;
		}

		.btn {
			display: inline-flex;
			align-items: center;
			gap: 10px;
			padding: 0 22px;
			height: 46px;
			border-radius: 14px;
			font-weight: 700;
			font-size: 14px;
			border: 1px solid transparent;
			cursor: pointer;
			transition: transform 0.18s ease, box-shadow 0.18s ease, background 0.18s ease, border-color 0.18s ease;
			letter-spacing: 0.2px;
			color: #fff;
			background: linear-gradient(135deg, var(--brand-800) 0%, #0a1530 100%);
			box-shadow: 0 14px 30px rgba(11, 18, 32, 0.18);
		}

		.btn i {
			font-size: 16px;
		}

		.btn:hover {
			transform: translateY(-2px);
			box-shadow: 0 18px 36px rgba(11, 18, 32, 0.24);
		}

		.btn.ghost {
			background: var(--surface);
			border-color: var(--border);
			color: var(--brand-800);
			box-shadow: none;
		}

		.btn.ghost:hover {
			border-color: var(--brand-500);
			color: var(--brand-500);
			box-shadow: 0 10px 20px rgba(15, 23, 42, 0.08);
		}

		.btn.danger {
			background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
			border-color: #dc2626;
			box-shadow: 0 18px 36px rgba(220, 38, 38, 0.25);
		}

		.btn.block-btn {
			width: 100%;
			justify-content: center;
		}

		.summary-grid {
			display: grid;
			grid-template-columns: repeat(4, minmax(0, 1fr));
			gap: 18px;
		}

		.summary-card {
			display: grid;
			grid-template-columns: auto 1fr;
			align-items: center;
			gap: 16px;
			background: var(--surface);
			border: 1px solid var(--border);
			border-radius: var(--radius-md);
			padding: 20px 22px;
			box-shadow: var(--shadow-card);
		}

		.summary-card__icon {
			width: 52px;
			height: 52px;
			border-radius: 14px;
			display: grid;
			place-items: center;
			font-size: 20px;
			color: #fff;
			background: var(--brand-500);
		}

		.summary-card__icon.is-green {
			background: var(--accent-green);
		}

		.summary-card__icon.is-purple {
			background: var(--accent-purple);
		}

		.summary-card__icon.is-orange {
			background: var(--accent-orange);
		}

		.summary-label {
			font-size: 12px;
			text-transform: uppercase;
			letter-spacing: 0.2em;
			color: var(--brand-muted);
		}

		.summary-value {
			font-size: 30px;
			font-weight: 800;
			color: var(--brand-800);
			line-height: 1.1;
		}

		.summary-foot {
			font-size: 13px;
			color: var(--brand-muted);
		}

		.layout-grid {
			display: block;
		}

		.calendar-shell {
			background: var(--surface);
			border: 1px solid var(--border);
			border-radius: var(--radius-lg);
			box-shadow: var(--shadow-soft);
			overflow: hidden;
			position: relative;
			display: flex;
			flex-direction: column;
			gap: 0;
		}

		.calendar-shell.is-loading::after {
			content: 'Carregando agenda...';
			position: absolute;
			inset: 0;
			background: rgba(245, 247, 251, 0.78);
			display: grid;
			place-items: center;
			font-weight: 700;
			color: var(--brand-700);
			font-size: 15px;
			z-index: 10;
		}

		.calendar-toolbar {
			display: grid;
			grid-template-columns: auto 1fr auto;
			align-items: center;
			gap: 18px;
			padding: 22px 26px 16px;
			background: var(--surface);
		}

		.calendar-toolbar h2 {
			margin: 0;
			font-size: 20px;
			font-weight: 800;
			color: var(--brand-800);
			text-align: center;
		}

		.toolbar-group {
			display: flex;
			align-items: center;
			gap: 10px;
			flex-wrap: wrap;
		}

		.toolbar-btn {
			width: 38px;
			height: 38px;
			border-radius: 12px;
			border: 1px solid var(--border);
			background: var(--surface-alt);
			color: var(--brand-800);
			display: grid;
			place-items: center;
			cursor: pointer;
			transition: background 0.18s ease, color 0.18s ease, border-color 0.18s ease;
		}

		.toolbar-btn:hover {
			background: var(--brand-800);
			color: #fff;
			border-color: var(--brand-800);
		}

		.view-switch {
			display: inline-flex;
			align-items: center;
			border: 1px solid var(--border);
			border-radius: 999px;
			overflow: hidden;
			background: var(--surface-alt);
		}

		.view-toggle {
			border: none;
			padding: 8px 18px;
			background: transparent;
			font-weight: 700;
			font-size: 13px;
			color: var(--brand-muted);
			cursor: pointer;
			transition: background 0.18s ease, color 0.18s ease;
		}

		.view-toggle.is-active {
			background: var(--brand-800);
			color: #fff;
		}

		.calendar-filters {
			display: flex;
			flex-direction: column;
			gap: 14px;
			padding: 0 26px 20px;
			background: var(--surface);
		}

		.search-field {
			position: relative;
			display: flex;
			align-items: center;
		}

		.search-field input {
			width: 100%;
			border-radius: 12px;
			border: 1px solid var(--border);
			background: var(--surface-alt);
			padding: 12px 16px 12px 42px;
			font-size: 14px;
			outline: none;
			transition: border-color 0.18s ease, box-shadow 0.18s ease;
		}

		.search-field input:focus {
			border-color: var(--brand-500);
			box-shadow: 0 0 0 3px rgba(47, 77, 165, 0.15);
			background: #fff;
		}

		.search-field i {
			position: absolute;
			left: 14px;
			color: var(--brand-muted);
			font-size: 15px;
		}

		.chip-group {
			display: flex;
			gap: 10px;
			flex-wrap: wrap;
		}

		.chip {
			border-radius: 999px;
			border: 1px solid var(--border);
			background: var(--surface-alt);
			color: var(--brand-muted);
			font-size: 12px;
			font-weight: 700;
			letter-spacing: 0.05em;
			padding: 8px 16px;
			cursor: pointer;
			transition: background 0.18s ease, color 0.18s ease, border-color 0.18s ease;
		}

		.chip.is-active {
			background: var(--brand-800);
			color: #fff;
			border-color: transparent;
		}

		.calendar-wrapper {
			padding: 0 0 24px;
		}

		#calendar {
			padding: 0 24px 12px;
		}

		.insights-panel {
			display: flex;
			flex-direction: column;
			gap: 20px;
		}

		.panel-card {
			background: var(--surface);
			border: 1px solid var(--border);
			border-radius: var(--radius-md);
			padding: 24px;
			box-shadow: var(--shadow-card);
		}

		.panel-header {
			display: flex;
			flex-direction: column;
			gap: 4px;
			margin-bottom: 18px;
		}

		.panel-header span:first-child {
			font-weight: 800;
			font-size: 15px;
			color: var(--brand-800);
		}

		.panel-subtitle {
			font-size: 13px;
			color: var(--brand-muted);
		}

		.panel-text {
			margin: 0 0 18px;
			font-size: 14px;
			color: var(--brand-muted);
		}

		.upcoming-list {
			list-style: none;
			margin: 0;
			padding: 0;
			display: flex;
			flex-direction: column;
			gap: 12px;
		}

		.upcoming-item {
			width: 100%;
			border: 1px solid var(--border);
			border-radius: 14px;
			background: var(--surface-alt);
			padding: 14px 16px;
			display: grid;
			grid-template-columns: 92px 1fr;
			gap: 16px;
			text-align: left;
			cursor: pointer;
			transition: transform 0.18s ease, box-shadow 0.18s ease, border-color 0.18s ease;
			color: inherit;
		}

		.upcoming-item.is-active,
		.upcoming-item:hover {
			transform: translateX(4px);
			border-color: var(--brand-500);
			box-shadow: 0 14px 30px rgba(15, 23, 42, 0.12);
			background: #fff;
		}

		.upcoming-item[data-event-type="bloqueio"] {
			border-left: 4px solid var(--accent-orange);
		}

		.upcoming-time {
			display: flex;
			flex-direction: column;
			gap: 2px;
			font-size: 13px;
			color: var(--brand-muted);
		}

		.upcoming-time strong {
			font-size: 16px;
			color: var(--brand-800);
		}

		.upcoming-body {
			display: flex;
			flex-direction: column;
			gap: 4px;
		}

		.upcoming-title {
			font-weight: 700;
			font-size: 15px;
			color: var(--brand-800);
		}

		.upcoming-meta {
			font-size: 13px;
			color: var(--brand-muted);
		}

		.empty-state {
			padding: 16px;
			border-radius: 12px;
			background: rgba(37, 99, 235, 0.08);
			color: #1d4ed8;
			font-weight: 600;
			text-align: center;
			font-size: 13px;
		}

		.type-breakdown {
			list-style: none;
			margin: 0;
			padding: 0;
			display: flex;
			flex-direction: column;
			gap: 14px;
		}

		.type-row {
			display: grid;
			grid-template-columns: auto 1fr auto;
			gap: 12px;
			align-items: center;
		}

		.type-label {
			font-weight: 600;
			font-size: 14px;
			color: var(--brand-800);
		}

		.type-bar {
			height: 10px;
			border-radius: 999px;
			background: var(--surface-alt);
			position: relative;
			overflow: hidden;
		}

		.type-bar-fill {
			position: absolute;
			left: 0;
			top: 0;
			bottom: 0;
			border-radius: inherit;
			background: var(--brand-500);
			transition: width 0.3s ease;
		}

		.type-row[data-type="retorno"] .type-bar-fill {
			background: var(--accent-green);
		}

		.type-row[data-type="procedimento"] .type-bar-fill {
			background: var(--accent-purple);
		}

		.type-row[data-type="bloqueio"] .type-bar-fill {
			background: var(--accent-orange);
		}

		.type-meta {
			font-size: 13px;
			color: var(--brand-muted);
			font-weight: 600;
		}

		.highlight-card {
			background: linear-gradient(145deg, rgba(19, 29, 53, 0.94) 0%, #0a1530 100%);
			color: #fff;
			border: none;
			box-shadow: 0 22px 42px rgba(9, 13, 28, 0.35);
		}

		.highlight-card .panel-header span:first-child {
			color: #fff;
		}

		.highlight-card .panel-text {
			color: rgba(255, 255, 255, 0.72);
		}

		/* FullCalendar tweaks */
		.fc {
			font-family: var(--font-family);
		}

		.fc .fc-toolbar {
			display: none;
		}

		.fc .fc-view-harness {
			background: var(--surface);
		}

		.fc .fc-col-header-cell {
			padding: 12px 8px !important;
			background: var(--surface-alt) !important;
			border-color: var(--border) !important;
		}

		.fc .fc-col-header-cell-cushion {
			color: var(--brand-800) !important;
			font-weight: 700 !important;
			font-size: 13px !important;
		}

		.fc .fc-scrollgrid,
		.fc .fc-scrollgrid-section>* {
			border-color: var(--border) !important;
		}

		.fc .fc-timegrid-slot {
			border-color: var(--border) !important;
			height: 42px !important;
		}

		.fc .fc-timegrid-slot-label {
			color: var(--brand-muted) !important;
			font-size: 12px !important;
			font-weight: 600 !important;
		}

		.fc .fc-timegrid-axis {
			width: 64px !important;
		}

		.fc .fc-day-today {
			background: rgba(37, 99, 235, 0.08) !important;
		}

		.fc .fc-daygrid-event,
		.fc .fc-timegrid-event {
			border: none !important;
			border-radius: 12px !important;
			padding: 0 !important;
			background: var(--brand-800) !important;
			color: #fff !important;
			box-shadow: 0 18px 36px rgba(15, 23, 42, 0.18);
		}

		.fc .fc-timegrid-event {
			display: flex;
			align-items: stretch;
			min-height: 52px;
			position: relative;
			overflow: hidden;
		}

		.fc .fc-timegrid-event .fc-event-main {
			width: 100%;
			display: flex;
			align-items: stretch;
		}

		.event-chip {
			width: 100%;
			height: 100%;
			display: flex;
			flex-direction: column;
			justify-content: center;
			gap: 4px;
			padding: 10px 14px;
			overflow: hidden;
		}

		.event-chip__title {
			font-size: 13px;
			font-weight: 700;
			color: #fff;
			line-height: 1.15;
			white-space: nowrap;
			overflow: hidden;
			text-overflow: ellipsis;
		}

		.event-chip__meta {
			font-size: 11px;
			font-weight: 600;
			opacity: 0.88;
			line-height: 1.2;
			white-space: nowrap;
			overflow: hidden;
			text-overflow: ellipsis;
		}

		.event-type-consulta {
			--event-accent: var(--accent-blue);
		}

		.event-type-retorno {
			--event-accent: var(--accent-green);
		}

		.event-type-procedimento {
			--event-accent: var(--accent-purple);
		}

		.event-type-bloqueio {
			--event-accent: var(--accent-orange);
		}

		.fc .event-type-consulta,
		.fc .event-type-retorno,
		.fc .event-type-procedimento,
		.fc .event-type-bloqueio {
			background: var(--event-accent, var(--brand-800)) !important;
		}

		.fc .holiday-event {
			opacity: 0.9;
		}

		.fc .holiday-event .event-chip__title::before {
			content: '\\f05e';
			font-family: "FontAwesome";
			margin-right: 6px;
		}

		.fc-direction-ltr .fc-timegrid-slot-label {
			text-align: right;
			padding-right: 12px !important;
		}

		.fc .fc-highlight {
			background: rgba(37, 99, 235, 0.12) !important;
		}

		/* Modals */
		.modal {
			display: none;
			position: fixed;
			inset: 0;
			background: rgba(9, 14, 28, 0.55);
			justify-content: center;
			align-items: center;
			z-index: 1200;
			padding: 18px;
			backdrop-filter: blur(6px);
		}

		.modal-card {
			width: 100%;
			max-width: 560px;
			background: var(--surface);
			border-radius: 20px;
			border: 1px solid rgba(226, 232, 240, 0.9);
			box-shadow: 0 28px 80px rgba(15, 23, 42, 0.35);
			padding: 32px;
			position: relative;
		}

		.modal-card h3 {
			margin: 0 0 24px;
			font-size: 22px;
			text-align: center;
			color: var(--brand-800);
			font-weight: 800;
		}

		.modal-close {
			position: absolute;
			top: 18px;
			right: 20px;
			background: none;
			border: none;
			color: var(--brand-muted);
			font-size: 22px;
			font-weight: 800;
			cursor: pointer;
			width: 32px;
			height: 32px;
			border-radius: 999px;
			transition: background 0.2s ease, color 0.2s ease;
		}

		.modal-close:hover {
			background: var(--surface-alt);
			color: var(--brand-800);
		}

		.form-group {
			margin-bottom: 16px;
		}

		.form-group label {
			display: block;
			margin-bottom: 8px;
			font-size: 13px;
			font-weight: 700;
			text-transform: uppercase;
			letter-spacing: 0.08em;
			color: var(--brand-muted);
		}

		.form-toggle {
			display: flex;
			flex-direction: column;
			gap: 8px;
		}

		.toggle-control {
			display: inline-flex;
			align-items: center;
			gap: 14px;
			cursor: pointer;
			user-select: none;
			font-weight: 700;
			color: var(--brand-800);
		}

		.toggle-control input {
			display: none;
		}

		.toggle-track {
			position: relative;
			width: 46px;
			height: 26px;
			border-radius: 999px;
			background: var(--surface-alt);
			border: 1px solid var(--border);
			transition: background 0.2s ease, border-color 0.2s ease;
		}

		.toggle-thumb {
			position: absolute;
			top: 3px;
			left: 3px;
			width: 20px;
			height: 20px;
			border-radius: 50%;
			background: #fff;
			box-shadow: 0 4px 10px rgba(15, 23, 42, 0.12);
			transition: transform 0.2s ease;
		}

		.toggle-control input:checked + .toggle-track {
			background: var(--brand-800);
			border-color: var(--brand-800);
		}

		.toggle-control input:checked + .toggle-track .toggle-thumb {
			transform: translateX(20px);
		}

		.toggle-control.is-disabled {
			opacity: 0.45;
			cursor: not-allowed;
		}

		.toggle-control.is-disabled .toggle-track {
			background: var(--surface-alt);
		}

		.form-hint {
			font-size: 12px;
			color: var(--brand-muted);
			line-height: 1.4;
		}

		.input,
		.textarea,
		.form-group select {
			width: 100%;
			border-radius: 12px;
			border: 1px solid var(--border);
			background: var(--surface-alt);
			padding: 12px 16px;
			font-size: 14px;
			color: var(--brand-900);
			outline: none;
			transition: border-color 0.18s ease, box-shadow 0.18s ease;
		}

		.input:focus,
		.textarea:focus,
		.form-group select:focus {
			border-color: var(--brand-500);
			box-shadow: 0 0 0 3px rgba(47, 77, 165, 0.15);
			background: #fff;
		}

		.textarea {
			min-height: 100px;
			resize: vertical;
		}

		.form-row {
			display: grid;
			grid-template-columns: repeat(2, minmax(0, 1fr));
			gap: 16px;
		}

		.modal-wide .modal-card {
			max-width: 980px;
			padding: 28px;
		}

		.wl-grid {
			display: grid;
			grid-template-columns: 1.1fr 0.9fr;
			gap: 22px;
		}

		.wl-list {
			border: 1px solid var(--border);
			border-radius: 16px;
			background: var(--surface-alt);
			min-height: 320px;
			display: flex;
			flex-direction: column;
			overflow: hidden;
		}

		.wl-list-head {
			padding: 16px;
			font-weight: 800;
			font-size: 14px;
			background: var(--surface);
			border-bottom: 1px solid var(--border);
		}

		.wl-items {
			flex: 1;
			padding: 16px;
			overflow-y: auto;
			display: flex;
			flex-direction: column;
			gap: 12px;
		}

		.wl-empty {
			padding: 16px;
			border-radius: 14px;
			background: rgba(37, 99, 235, 0.08);
			color: #1d4ed8;
			text-align: center;
			font-weight: 600;
			font-size: 13px;
		}

		.wl-item {
			background: #fff;
			border-radius: 14px;
			border: 1px solid var(--border);
			padding: 14px 16px;
			box-shadow: 0 16px 30px rgba(15, 23, 42, 0.08);
			display: flex;
			justify-content: space-between;
			gap: 14px;
		}

		.wl-item h4 {
			margin: 0 0 4px;
			font-size: 15px;
			color: var(--brand-800);
		}

		.wl-item small {
			color: var(--brand-muted);
			display: block;
			line-height: 1.4;
		}

		.wl-actions {
			display: flex;
			gap: 8px;
		}

		.wl-btn {
			border: 1px solid var(--border);
			background: var(--surface-alt);
			border-radius: 10px;
			padding: 6px 10px;
			cursor: pointer;
			color: var(--brand-800);
			transition: background 0.18s ease, color 0.18s ease, border-color 0.18s ease;
		}

		.wl-btn:hover {
			border-color: #ef4444;
			background: rgba(239, 68, 68, 0.1);
			color: #b91c1c;
		}

		.wl-form {
			border: 1px solid var(--border);
			border-radius: 16px;
			background: var(--surface);
			padding: 18px;
		}

		.input-icon {
			position: relative;
		}

		.input-icon input {
			padding-right: 42px;
		}

		.input-icon .search-btn {
			position: absolute;
			right: 8px;
			top: 50%;
			transform: translateY(-50%);
			width: 32px;
			height: 32px;
			border-radius: 10px;
			border: 1px solid var(--border);
			background: var(--surface-alt);
			display: grid;
			place-items: center;
			color: var(--brand-muted);
			cursor: pointer;
		}

		.input-icon .search-btn:hover {
			border-color: var(--brand-500);
			color: var(--brand-500);
		}

		@media (max-width: 1280px) {
			.summary-grid {
				grid-template-columns: repeat(2, minmax(0, 1fr));
			}

			.page-hero {
				grid-template-columns: 1fr;
			}

			.page-hero__insights {
				flex-direction: row;
				flex-wrap: wrap;
			}

			.page-hero__insights .panel-card {
				flex: 1 1 280px;
			}
		}

		@media (max-width: 920px) {
			.content {
				padding: 32px 24px;
			}

			.page-hero {
				padding: 24px;
			}

			.page-hero__insights {
				flex-direction: column;
			}

			.page-hero__insights .panel-card {
				width: 100%;
			}

			.calendar-toolbar {
				display: flex;
				flex-direction: column;
				align-items: stretch;
				gap: 16px;
			}

			.calendar-toolbar h2 {
				text-align: left;
			}

			.toolbar-group {
				justify-content: space-between;
			}

			#calendar {
				padding: 0 14px 12px;
			}

			.summary-card {
				grid-template-columns: 1fr;
				text-align: left;
			}

			.summary-card__icon {
				justify-self: start;
			}

			.form-row {
				grid-template-columns: 1fr;
			}

			.wl-grid {
				grid-template-columns: 1fr;
			}
		}

		@media (max-width: 720px) {
			.sidebar {
				display: none;
			}

			.content {
				padding: 24px 16px;
			}

			.main-shell {
				gap: 24px;
			}

			.summary-grid {
				grid-template-columns: 1fr;
			}

			.page-hero__actions {
				width: 100%;
			}

			.btn {
				flex: 1 1 100%;
				justify-content: center;
			}

			.chip-group {
				gap: 8px;
			}

			.chip {
				padding: 8px 14px;
			}

			.upcoming-item {
				grid-template-columns: 1fr;
			}

			.top-profile {
				right: 18px;
			}
		}
	</style>
	<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
</head>

<body>
	<div class="top-profile" aria-label="Ações do usuário">
		<a href="{{ url_for('account') }}" class="icon-btn" title="Minha conta" aria-label="Minha conta"><i class="fa fa-user"></i></a>
		<button class="icon-btn" type="button" title="Notificações" aria-label="Notificações">
			<i class="fa fa-bell"></i><span class="badge">{{ (notifications_unread or 0) }}</span>
		</button>
	</div>

	<div class="sidebar" id="sidebar">
		<button class="sidebar-toggle" onclick="toggleSidebar()" aria-label="Minimizar/Maximizar menu"><i class="fa fa-angle-double-left"></i></button>
		<img src="{{ url_for('static', filename='images/3.svg') }}" class="sidebar-logo" alt="Ponza Health" />
		<a href="{{ url_for('index') }}" class="menu-item"><i class="fa fa-home"></i><span class="label">Início</span></a>
		<a href="{{ url_for('upload') }}" class="menu-item"><i class="fa fa-upload"></i><span class="label">Ponza Lab</span></a>
		<a href="{{ url_for('quote_index') }}" class="menu-item"><i class="fa fa-file-text-o"></i><span class="label">Cotações</span></a>
		<a href="{{ url_for('catalog') }}" class="menu-item"><i class="fa fa-users"></i><span class="label">Pacientes</span></a>
		<a href="{{ url_for('products') }}" class="menu-item"><i class="fa fa-archive"></i><span class="label">Estoque</span></a>
		<a href="{{ url_for('agenda') }}" class="menu-item active"><i class="fa fa-calendar"></i><span class="label">Agenda</span></a>
		<a href="{{ url_for('purchase') }}" class="menu-item"><i class="fa fa-credit-card"></i><span class="label">Pagamentos</span></a>
		<div class="sidebar-spacer"></div>
		<a href="{{ url_for('logout') }}" class="menu-item logout"><i class="fa fa-sign-out"></i><span class="label">Sair</span></a>
	</div>

	<div class="content">
		<div class="main-shell">
			<section class="page-hero">
				<div class="page-hero__main">
					<div class="page-hero__text">
						<span class="eyebrow">Agenda</span>
						<h1>Coordene seu dia com clareza</h1>
						<p>Você tem {{ summary.today_count or 0 }} compromissos hoje e {{ summary.upcoming_count or 0 }} nos próximos 7 dias. Use os filtros para localizar pacientes e tipos rapidamente.</p>
					</div>
					<div class="page-hero__actions">
						<button class="btn" id="newEventBtn" type="button"><i class="fa fa-plus"></i><span>Novo agendamento</span></button>
					</div>
				</div>
				<div class="page-hero__insights">
					<section class="panel-card hero-card highlight-card">
						<div class="panel-header">
							<span>Lista de espera</span>
						</div>
						<p class="panel-text">Você tem <strong data-waitlist-count>{{ waitlist_count or 0 }}</strong> paciente(s) aguardando encaixe.</p>
						<button class="btn block-btn" type="button" data-open-waitlist><i class="fa fa-users"></i><span>Abrir lista de espera</span></button>
					</section>
				</div>
			</section>

			<section class="summary-grid">
				<article class="summary-card">
					<div class="summary-card__icon"><i class="fa fa-calendar-check-o"></i></div>
					<div>
						<span class="summary-label">Hoje</span>
						<strong class="summary-value" data-summary="today">{{ summary.today_count or 0 }}</strong>
						<span class="summary-foot">Consultas confirmadas</span>
					</div>
				</article>
				<article class="summary-card">
					<div class="summary-card__icon is-green"><i class="fa fa-calendar"></i></div>
					<div>
						<span class="summary-label">Semana</span>
						<strong class="summary-value" data-summary="week">{{ summary.week_count or 0 }}</strong>
						<span class="summary-foot">Compromissos nesta semana</span>
					</div>
				</article>
				<article class="summary-card">
					<div class="summary-card__icon is-purple"><i class="fa fa-refresh"></i></div>
					<div>
						<span class="summary-label">Retornos</span>
						<strong class="summary-value" data-summary="returns">{{ summary.returns_count or 0 }}</strong>
						<span class="summary-foot">Retornos planejados</span>
					</div>
				</article>
				<article class="summary-card">
					<div class="summary-card__icon is-orange"><i class="fa fa-ban"></i></div>
					<div>
						<span class="summary-label">Bloqueios</span>
						<strong class="summary-value" data-summary="blocked">{{ summary.blocked_count or 0 }}</strong>
						<span class="summary-foot">Períodos reservados</span>
					</div>
				</article>
			</section>

			<div class="calendar-shell" id="calendarShell">
				<div class="calendar-toolbar">
					<div class="toolbar-group">
						<button class="toolbar-btn" id="prevBtn" type="button" aria-label="Período anterior"><i class="fa fa-chevron-left"></i></button>
						<button class="toolbar-btn" id="todayBtn" type="button">Hoje</button>
						<button class="toolbar-btn" id="nextBtn" type="button" aria-label="Próximo período"><i class="fa fa-chevron-right"></i></button>
					</div>
					<h2 id="calendarPeriod">Semana atual</h2>
					<div class="toolbar-group">
						<div class="view-switch">
							<button class="view-toggle" data-view="dayGridMonth" type="button">Mês</button>
							<button class="view-toggle is-active" data-view="timeGridWeek" type="button">Semana</button>
						</div>
					</div>
				</div>
				<div class="calendar-filters">
					<div class="search-field">
						<i class="fa fa-search"></i>
						<input type="search" id="agendaSearch" placeholder="Buscar por paciente, convênio ou observação">
					</div>
					<div class="chip-group" id="typeFilterGroup">
						<button class="chip is-active" data-filter-all="true" type="button">Todos</button>
						<button class="chip is-active" data-filter-type="consulta" type="button">Consultas</button>
						<button class="chip is-active" data-filter-type="retorno" type="button">Retornos</button>
						<button class="chip is-active" data-filter-type="procedimento" type="button">Procedimentos</button>
						<button class="chip is-active" data-filter-type="bloqueio" type="button">Bloqueios</button>
					</div>
				</div>
				<div class="calendar-wrapper">
					<div id="calendar"></div>
				</div>
			</div>
		</div>
	</div>

	<div id="addModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="addTitle">
		<div class="modal-card">
			<button class="modal-close" type="button" onclick="closeModal('addModal')" aria-label="Fechar">×</button>
			<h3 id="addTitle">Novo agendamento</h3>

			<div class="form-group">
				<label for="add_title">Paciente</label>
				<input type="text" id="add_title" class="input" placeholder="Nome do paciente" required>
			</div>

			<div class="form-group">
				<label for="add_phone">Telefone do paciente</label>
				<input type="tel" id="add_phone" class="input" placeholder="(__) _____-____" required>
			</div>

			<div class="form-toggle">
				<label class="toggle-control" for="add-send-reminders">
					<input type="checkbox" id="add-send-reminders" name="send_reminders" checked>
					<span class="toggle-track"><span class="toggle-thumb"></span></span>
					<span>Receber lembretes por WhatsApp</span>
				</label>
				<p class="form-hint">Pacientes recebem um lembrete automático 60 minutos antes do horário agendado.</p>
			</div>

			<div class="form-row">
				<div class="form-group">
					<label for="add_date">Data</label>
					<input type="text" id="add_date" class="input" placeholder="dd/mm/aaaa" inputmode="numeric" pattern="\d{2}/\d{2}/\d{4}" required>
				</div>
				<div class="form-group">
					<label for="add_time">Horário</label>
					<input type="time" id="add_time" class="input" placeholder="Horário de início">
				</div>
			</div>

			<div class="form-row">
				<div class="form-group">
					<label for="add_end">Término</label>
					<input type="time" id="add_end" class="input" placeholder="Horário de término">
				</div>
				<div class="form-group">
					<label for="add_type">Tipo</label>
					<select id="add_type" class="input">
						<option value="consulta">Consulta</option>
						<option value="retorno">Retorno</option>
						<option value="procedimento">Procedimento</option>
						<option value="bloqueio">Bloqueio</option>
					</select>
				</div>
			</div>

			<div class="form-row">
				<div class="form-group">
					<label for="add_billing">Pagamento</label>
					<select id="add_billing" class="input" data-insurer-wrap="add_insurerWrap">
						<option value="particular">Particular</option>
						<option value="convenio">Convênio</option>
					</select>
				</div>
				<div class="form-group" id="add_insurerWrap" style="display:none;">
					<label for="add_insurer">Convênio</label>
					<input type="text" id="add_insurer" class="input" placeholder="Nome do convênio">
				</div>
			</div>

			<div class="form-group">
				<label for="add_notes">Observações</label>
				<textarea id="add_notes" class="textarea" placeholder="Observações adicionais" rows="3"></textarea>
			</div>

			<button class="btn block-btn" type="button" onclick="submitAddEvent()"><i class="fa fa-save"></i><span>Salvar agendamento</span></button>
		</div>
	</div>

	<div id="editModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="editTitle">
		<div class="modal-card">
			<button class="modal-close" type="button" onclick="closeModal('editModal')" aria-label="Fechar">×</button>
			<h3 id="editTitle">Editar agendamento</h3>
			<input type="hidden" id="edit_id" />

			<div class="form-group">
				<label for="edit_title">Paciente</label>
				<input type="text" id="edit_title" class="input" required>
			</div>

			<div class="form-group">
				<label for="edit_phone">Telefone do paciente</label>
				<input type="tel" id="edit_phone" class="input" required>
			</div>

			<div class="form-toggle">
				<label class="toggle-control" for="edit-send-reminders">
					<input type="checkbox" id="edit-send-reminders" name="send_reminders">
					<span class="toggle-track"><span class="toggle-thumb"></span></span>
					<span>Receber lembretes por WhatsApp</span>
				</label>
				<p class="form-hint">Pacientes recebem um lembrete automático 60 minutos antes do horário agendado.</p>
			</div>

			<div class="form-row">
				<div class="form-group">
					<label for="edit_date">Data</label>
					<input type="text" id="edit_date" class="input" placeholder="dd/mm/aaaa" inputmode="numeric" pattern="\d{2}/\d{2}/\d{4}" required>
				</div>
				<div class="form-group">
					<label for="edit_time">Horário</label>
					<input type="time" id="edit_time" class="input">
				</div>
			</div>

			<div class="form-row">
				<div class="form-group">
					<label for="edit_end">Término</label>
					<input type="time" id="edit_end" class="input">
				</div>
				<div class="form-group">
					<label for="edit_type">Tipo</label>
					<select id="edit_type" class="input">
						<option value="consulta">Consulta</option>
						<option value="retorno">Retorno</option>
						<option value="procedimento">Procedimento</option>
						<option value="bloqueio">Bloqueio</option>
					</select>
				</div>
			</div>

			<div class="form-row">
				<div class="form-group">
					<label for="edit_billing">Pagamento</label>
					<select id="edit_billing" class="input" data-insurer-wrap="edit_insurerWrap">
						<option value="particular">Particular</option>
						<option value="convenio">Convênio</option>
					</select>
				</div>
				<div class="form-group" id="edit_insurerWrap" style="display:none;">
					<label for="edit_insurer">Convênio</label>
					<input type="text" id="edit_insurer" class="input" placeholder="Nome do convênio">
				</div>
			</div>

			<div class="form-group">
				<label for="edit_notes">Observações</label>
				<textarea id="edit_notes" class="textarea" rows="3"></textarea>
			</div>

			<div style="display:flex; gap:12px;">
				<button class="btn danger" type="button" onclick="deleteEvent()" style="flex:0 0 160px;"><i class="fa fa-trash"></i><span>Excluir</span></button>
				<button class="btn block-btn" type="button" onclick="submitEditEvent()"><i class="fa fa-save"></i><span>Salvar alterações</span></button>
			</div>
		</div>
	</div>

	<div id="waitlistModal" class="modal modal-wide" role="dialog" aria-modal="true" aria-labelledby="wlTitle">
		<div class="modal-card">
			<button class="modal-close" type="button" onclick="closeModal('waitlistModal')" aria-label="Fechar">×</button>
			<h3 id="wlTitle">Lista de espera</h3>

			<div class="wl-grid">
				<div class="wl-list">
					<div class="wl-list-head">Na lista</div>
					<div id="wlItems" class="wl-items">
						<div class="wl-empty" id="wlEmpty">Nenhum paciente na lista de espera</div>
					</div>
				</div>

				<div class="wl-form">
					<div class="form-group">
						<label for="wl_patient">Paciente</label>
						<div class="input-icon">
							<input id="wl_patient" class="input" type="text" placeholder="Nome do paciente" autocomplete="off">
							<button class="search-btn" type="button"><i class="fa fa-search"></i></button>
						</div>
					</div>

					<div class="form-group">
						<label for="wl_billing">Convênio</label>
						<select id="wl_billing" class="input">
							<option value="Particular" selected>Particular</option>
							<option value="Convênio">Convênio</option>
						</select>
					</div>

					<div class="form-group">
						<label for="wl_email">E-mail</label>
						<input id="wl_email" class="input" type="email" placeholder="email@exemplo.com">
					</div>

					<div class="form-row">
						<div class="form-group">
							<label for="wl_phone1">Tel. celular</label>
							<input id="wl_phone1" class="input" type="tel" placeholder="(__) _____-____">
						</div>
						<div class="form-group">
							<label for="wl_phone2">Tel. residencial</label>
							<input id="wl_phone2" class="input" type="tel" placeholder="(__) ____-____">
						</div>
					</div>

					<div class="form-group">
						<label for="wl_notes">Observação</label>
						<input id="wl_notes" class="input" type="text" placeholder="">
					</div>

					<button class="btn block-btn" type="button" onclick="addToWaitlist()"><i class="fa fa-plus"></i><span>Adicionar paciente</span></button>
				</div>
			</div>
		</div>
	</div>

	<script>
		const TYPE_LABELS = {
			consulta: 'Consulta',
			retorno: 'Retorno',
			procedimento: 'Procedimento',
			bloqueio: 'Bloqueio'
		};

		const EVENT_COLORS = {
			consulta: '#2563eb',
			retorno: '#22c55e',
			procedimento: '#7c3aed',
			bloqueio: '#f97316'
		};

		let calendar;
		let calendarShell;
		let typeButtons = [];
		let allTypeChip = null;
		let searchInput;

		const state = {
			activeTypes: new Set(),
			searchTerm: ''
		};

		function toggleSidebar() {
			const s = document.getElementById('sidebar');
			if (!s) return;
			s.classList.toggle('is-collapsed');
			localStorage.setItem('sidebarCollapsed', s.classList.contains('is-collapsed') ? '1' : '0');
			if (window.calendar && typeof window.calendar.updateSize === 'function') {
				setTimeout(() => window.calendar.updateSize(), 210);
			}
		}

		document.addEventListener('DOMContentLoaded', () => {
			if (localStorage.getItem('sidebarCollapsed') === '1') {
				document.getElementById('sidebar')?.classList.add('is-collapsed');
			}

			calendarShell = document.getElementById('calendarShell');
			searchInput = document.getElementById('agendaSearch');

			setupTypeFilters();
		  hydrateServerTypeBreakdown();
			bindWaitlistTriggers();
			bindUpcomingQuickLinks();
			setupCalendar();
			bindStaticActions();

			const addTypeEl = document.getElementById('add_type');
			const addToggleEl = document.getElementById('add-send-reminders');
			if (addTypeEl && addToggleEl) {
				addTypeEl.addEventListener('change', () => syncReminderToggleState(addTypeEl, addToggleEl));
			}

			const editTypeEl = document.getElementById('edit_type');
			const editToggleEl = document.getElementById('edit-send-reminders');
			if (editTypeEl && editToggleEl) {
				editTypeEl.addEventListener('change', () => syncReminderToggleState(editTypeEl, editToggleEl));
			}
		});

		function setupTypeFilters() {
			const group = document.getElementById('typeFilterGroup');
			if (!group) return;
			typeButtons = Array.from(group.querySelectorAll('[data-filter-type]'));
			allTypeChip = group.querySelector('[data-filter-all]');

			if (!state.activeTypes.size) {
				typeButtons.forEach(btn => {
					const type = btn.getAttribute('data-filter-type');
					if (type) {
						state.activeTypes.add(type);
					}
				});
			}

			typeButtons.forEach(btn => {
				btn.addEventListener('click', () => handleTypeChipClick(btn));
			});

			if (allTypeChip) {
				allTypeChip.addEventListener('click', () => resetTypeFilters());
			}

			refreshTypeChips(false);

			if (searchInput) {
				const debounced = debounce(value => {
					state.searchTerm = value;
					calendar?.refetchEvents();
				}, 250);
				searchInput.addEventListener('input', ev => debounced(ev.target.value.trim()));
			}
		}

		function handleTypeChipClick(btn) {
			const type = btn.getAttribute('data-filter-type');
			if (!type) return;
			if (state.activeTypes.has(type)) {
				if (state.activeTypes.size === 1) {
					return;
				}
				state.activeTypes.delete(type);
			} else {
				state.activeTypes.add(type);
			}
			refreshTypeChips();
		}

		function resetTypeFilters() {
			state.activeTypes.clear();
			typeButtons.forEach(btn => {
				const type = btn.getAttribute('data-filter-type');
				if (type) {
					state.activeTypes.add(type);
				}
			});
			refreshTypeChips();
		}

		function refreshTypeChips(triggerRefetch = true) {
			typeButtons.forEach(btn => {
				const type = btn.getAttribute('data-filter-type');
				if (!type) return;
				btn.classList.toggle('is-active', state.activeTypes.has(type));
			});
			if (allTypeChip) {
				allTypeChip.classList.toggle('is-active', state.activeTypes.size === typeButtons.length);
			}
			if (triggerRefetch && calendar) {
				calendar.refetchEvents();
			}
		}

		function hydrateServerTypeBreakdown() {
		  document.querySelectorAll('.type-bar-fill[data-width]').forEach(el => {
			const raw = parseFloat(el.getAttribute('data-width'));
			const value = Number.isFinite(raw) ? Math.min(100, Math.max(0, raw)) : 0;
			el.style.width = `${value}%`;
		  });
		}

		function setupCalendar() {
			const calendarEl = document.getElementById('calendar');
			if (!calendarEl) return;

			calendar = new FullCalendar.Calendar(calendarEl, {
				timeZone: 'local',
				initialView: 'timeGridWeek',
				locale: 'pt-br',
				headerToolbar: false,
				nowIndicator: true,
				slotMinTime: '07:00:00',
				slotMaxTime: '19:00:00',
				slotDuration: '00:15:00',
				expandRows: true,
				dayMaxEventRows: 3,
				stickyHeaderDates: true,
				height: 'auto',
				handleWindowResize: true,
				selectable: true,
				selectMirror: true,
				editable: true,
				eventStartEditable: true,
				eventDurationEditable: true,
				dragScroll: true,
				events: {
					url: '/api/events',
					extraParams: () => ({
						types: Array.from(state.activeTypes).join(','),
						search: state.searchTerm
					})
				},
				loading: isLoading => {
					if (calendarShell) {
						calendarShell.classList.toggle('is-loading', isLoading);
					}
				},
				eventTimeFormat: { hour: '2-digit', minute: '2-digit', hour12: false },
				dayHeaderFormat: { weekday: 'short', day: '2-digit', month: '2-digit' },
				select: handleSelect,
				eventClick: handleEventClick,
				eventDrop: handleEventMove,
				eventResize: handleEventMove,
				eventContent: buildEventContent,
				eventDidMount: colorizeEvent,
				datesSet: updatePeriodDisplay
			});

			calendar.render();
			updatePeriodDisplay();

			window.addEventListener('resize', () => calendar.updateSize());
			setTimeout(() => calendar.updateSize(), 0);
			window.calendar = calendar;

			document.getElementById('prevBtn')?.addEventListener('click', () => calendar.prev());
			document.getElementById('nextBtn')?.addEventListener('click', () => calendar.next());
			document.getElementById('todayBtn')?.addEventListener('click', () => calendar.today());

			document.querySelectorAll('.view-toggle').forEach(btn => {
				btn.addEventListener('click', () => {
					const viewName = btn.getAttribute('data-view');
					if (!viewName) return;
					calendar.changeView(viewName);
					updateViewButtons(viewName);
				});
			});

			updateViewButtons('timeGridWeek');
			refreshAgendaSnapshot();
		}

		function buildEventContent(arg) {
			const wrapper = document.createElement('div');
			wrapper.className = 'event-chip';

			const title = document.createElement('div');
			title.className = 'event-chip__title';
			title.textContent = arg.event.title || 'Evento';
			wrapper.appendChild(title);

			const meta = document.createElement('div');
			meta.className = 'event-chip__meta';
			const type = (arg.event.extendedProps?.type || '').toLowerCase();
			const billing = arg.event.extendedProps?.billing || '';
			const pieces = [];

			if (arg.view.type === 'dayGridMonth' && arg.timeText) {
				pieces.push(arg.timeText);
			}
			if (TYPE_LABELS[type]) {
				pieces.push(TYPE_LABELS[type]);
			}
			if (billing) {
				pieces.push(capitalize(billing));
			}
			meta.textContent = pieces.join(' · ');
			if (meta.textContent) {
				wrapper.appendChild(meta);
			}

			return { domNodes: [wrapper] };
		}

		function colorizeEvent(info) {
			const type = (info.event.extendedProps?.type || '').toLowerCase();
			const color = EVENT_COLORS[type] || '#131d35';
			info.el.style.setProperty('--event-accent', color);
		}

		function handleSelect(info) {
			const start = info.start;
			const end = info.end;
			const dateBR = toBR(start);
			const timeStr = `${String(start.getHours()).padStart(2, '0')}:${String(start.getMinutes()).padStart(2, '0')}`;
			const endStr = end ? `${String(end.getHours()).padStart(2, '0')}:${String(end.getMinutes()).padStart(2, '0')}` : '';
			openAddModal({ dateBR, time: timeStr, endTime: endStr });
			calendar.unselect();
		}

		function handleEventClick(info) {
			const ev = info.event;
			if (ev.classNames.includes('holiday-event')) return;
			if (!ev.id) return;
			const start = ev.start;
			const end = ev.end || null;
			const dateBR = toBR(start);
			const time = `${String(start.getHours()).padStart(2, '0')}:${String(start.getMinutes()).padStart(2, '0')}`;
			const endTime = end ? `${String(end.getHours()).padStart(2, '0')}:${String(end.getMinutes()).padStart(2, '0')}` : '';
			openEditModal({
				id: ev.id,
				title: ev.title || '',
				phone: ev.extendedProps?.phone || '',
				dateBR,
				time,
				endTime,
				notes: ev.extendedProps?.notes || '',
				type: (ev.extendedProps?.type || 'consulta').toLowerCase(),
				billing: (ev.extendedProps?.billing || 'particular').toLowerCase(),
				insurer: ev.extendedProps?.insurer || '',
				send_reminders: Boolean(ev.extendedProps?.send_reminders)
			});
		}

		async function handleEventMove(info) {
			const ev = info.event;
			if (ev.classNames.includes('holiday-event') || !ev.id) {
				info.revert();
				return;
			}
			try {
				const payload = {
					start: ev.start ? formatLocalISO(ev.start) : null,
					end: ev.end ? formatLocalISO(ev.end) : null
				};
				const res = await fetch(`/api/events/${encodeURIComponent(ev.id)}`, {
					method: 'PUT',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify(payload)
				});
				const result = await res.json();
				if (!result.success) {
					info.revert();
					alert('Não foi possível atualizar o evento.');
				} else {
					refreshAgendaSnapshot();
				}
			} catch (error) {
				info.revert();
				alert('Falha de rede ao atualizar o evento.');
			}
		}

		function updateViewButtons(viewName) {
			document.querySelectorAll('.view-toggle').forEach(btn => {
				const value = btn.getAttribute('data-view');
				btn.classList.toggle('is-active', value === viewName);
			});
		}

		function updatePeriodDisplay() {
			if (!calendar) return;
			const view = calendar.view;
			const start = view.currentStart;
			const end = new Date(view.currentEnd.getTime() - 24 * 60 * 60 * 1000);
			const periodEl = document.getElementById('calendarPeriod');
			if (!periodEl) return;

			if (view.type === 'timeGridWeek') {
				const startStr = start.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
				const endStr = end.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
				periodEl.textContent = `${startStr} a ${endStr}`;
			} else if (view.type === 'dayGridMonth') {
				periodEl.textContent = start.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
			} else {
				periodEl.textContent = start.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
			}
		}

		function bindStaticActions() {
			document.getElementById('newEventBtn')?.addEventListener('click', () => openAddModal());
		}

		function bindWaitlistTriggers() {
			document.querySelectorAll('[data-open-waitlist]').forEach(btn => {
				btn.addEventListener('click', openWaitlistModal);
			});
		}

		function bindUpcomingQuickLinks() {
			const items = document.querySelectorAll('.js-upcoming-item');
			items.forEach(item => {
				item.addEventListener('click', () => {
					document.querySelectorAll('.upcoming-item.is-active').forEach(active => active.classList.remove('is-active'));
					item.classList.add('is-active');
					const startIso = item.getAttribute('data-event-start');
					if (startIso && calendar) {
						calendar.gotoDate(startIso);
					}
				});
			});
		}

		function debounce(fn, wait = 200) {
			let timeout;
			return function (...args) {
				const context = this;
				clearTimeout(timeout);
				timeout = setTimeout(() => fn.apply(context, args), wait);
			};
		}

		function toBR(date) {
			const d = String(date.getDate()).padStart(2, '0');
			const m = String(date.getMonth() + 1).padStart(2, '0');
			const y = String(date.getFullYear());
			return `${d}/${m}/${y}`;
		}

		function parseBR(dateStr) {
			if (!dateStr) return null;
			const m = /^(\d{2})\/(\d{2})\/(\d{4})$/.exec(dateStr);
			if (!m) return null;
			const d = parseInt(m[1], 10), mo = parseInt(m[2], 10) - 1, y = parseInt(m[3], 10);
			const dt = new Date(y, mo, d);
			return (dt && dt.getFullYear() === y && dt.getMonth() === mo && dt.getDate() === d) ? dt : null;
		}

		function formatLocalISO(date) {
			if (!date) return null;
			const pad = n => String(n).padStart(2, '0');
			return `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(date.getDate())}T${pad(date.getHours())}:${pad(date.getMinutes())}:00`;
		}

		function buildLocalISO(dateBR, timeStr) {
			const base = parseBR(dateBR);
			if (!base) return null;
			const t = (timeStr && timeStr.length) ? timeStr : '08:00';
			const [hh, mm] = t.split(':').map(Number);
			base.setHours(hh || 0, mm || 0, 0, 0);
			return formatLocalISO(base);
		}

		function setupBillingToggle(selectEl) {
			const wrapId = selectEl.getAttribute('data-insurer-wrap');
			const wrap = document.getElementById(wrapId);
			const update = () => {
				if (wrap) wrap.style.display = (selectEl.value === 'convenio') ? 'block' : 'none';
			};
			selectEl.addEventListener('change', update);
			update();
		}

		function syncReminderToggleState(selectEl, toggleInput) {
			if (!selectEl || !toggleInput) return;
			const control = toggleInput.closest('.toggle-control');
			const isBlocked = selectEl.value === 'bloqueio';
			if (isBlocked) {
				toggleInput.dataset.prevChecked = toggleInput.checked ? '1' : '0';
				toggleInput.checked = false;
			} else if (toggleInput.disabled) {
				const prev = toggleInput.dataset.prevChecked;
				if (prev !== undefined) {
					toggleInput.checked = prev === '1';
					delete toggleInput.dataset.prevChecked;
				}
			}
			toggleInput.disabled = isBlocked;
			if (control) control.classList.toggle('is-disabled', isBlocked);
		}

		function openModal(id) {
			const el = document.getElementById(id);
			if (el) el.style.display = 'flex';
		}

		function closeModal(id) {
			const el = document.getElementById(id);
			if (el) el.style.display = 'none';
		}

		function openAddModal(prefill) {
			document.getElementById('add_title').value = prefill?.title || '';
			document.getElementById('add_phone').value = prefill?.phone || '';
			document.getElementById('add_date').value = prefill?.dateBR || '';
			document.getElementById('add_time').value = prefill?.time || '';
			document.getElementById('add_end').value = prefill?.endTime || '';
			document.getElementById('add_notes').value = prefill?.notes || '';
			document.getElementById('add_type').value = prefill?.type || 'consulta';
			document.getElementById('add_billing').value = prefill?.billing || 'particular';
			document.getElementById('add_insurer').value = prefill?.insurer || '';
			setupBillingToggle(document.getElementById('add_billing'));
			const addTypeEl = document.getElementById('add_type');
			const addToggleEl = document.getElementById('add-send-reminders');
			if (addToggleEl) {
				addToggleEl.checked = typeof prefill?.send_reminders === 'boolean' ? prefill.send_reminders : true;
				delete addToggleEl.dataset.prevChecked;
				syncReminderToggleState(addTypeEl, addToggleEl);
			}
			openModal('addModal');
		}

		function openEditModal(prefill) {
			document.getElementById('edit_id').value = prefill?.id || '';
			document.getElementById('edit_title').value = prefill?.title || '';
			document.getElementById('edit_phone').value = prefill?.phone || '';
			document.getElementById('edit_date').value = prefill?.dateBR || '';
			document.getElementById('edit_time').value = prefill?.time || '';
			document.getElementById('edit_end').value = prefill?.endTime || '';
			document.getElementById('edit_notes').value = prefill?.notes || '';
			document.getElementById('edit_type').value = prefill?.type || 'consulta';
			document.getElementById('edit_billing').value = prefill?.billing || 'particular';
			document.getElementById('edit_insurer').value = prefill?.insurer || '';
			setupBillingToggle(document.getElementById('edit_billing'));
			const editTypeEl = document.getElementById('edit_type');
			const editToggleEl = document.getElementById('edit-send-reminders');
			if (editToggleEl) {
				editToggleEl.checked = !!prefill?.send_reminders;
				delete editToggleEl.dataset.prevChecked;
				syncReminderToggleState(editTypeEl, editToggleEl);
			}
			openModal('editModal');
		}

		async function submitAddEvent() {
			const title = document.getElementById('add_title').value.trim();
			const phone = document.getElementById('add_phone').value.trim();
			const dateBR = document.getElementById('add_date').value;
			const time = document.getElementById('add_time').value;
			const endTime = document.getElementById('add_end').value;
			const notes = document.getElementById('add_notes').value;
			const type = document.getElementById('add_type').value;
			const billing = document.getElementById('add_billing').value;
			const insurer = (document.getElementById('add_insurer').value || '').trim();
			const sendRemindersInput = document.getElementById('add-send-reminders');
			const sendReminders = sendRemindersInput ? sendRemindersInput.checked : false;

			if (!title || !phone || !dateBR) {
				alert('Preencha o nome, telefone e a data.');
				return;
			}

			const startISO = buildLocalISO(dateBR, time);
			let endISO = endTime ? buildLocalISO(dateBR, endTime) : null;
			if (endISO) {
				const s = new Date(startISO);
				const e = new Date(endISO);
				if (!(e > s)) endISO = null;
			}

			const payload = { title, phone, start: startISO, end: endISO, notes, type, billing, insurer, send_reminders: type !== 'bloqueio' && sendReminders };

			try {
				const res = await fetch('/api/add_event', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify(payload)
				});
				const result = await res.json();
				if (result.success) {
					closeModal('addModal');
					calendar?.refetchEvents();
					refreshAgendaSnapshot();
				} else {
					alert('Erro: ' + (result.error || 'Erro desconhecido'));
				}
			} catch (error) {
				alert('Falha de rede ao salvar. Tente novamente.');
			}
		}

		async function submitEditEvent() {
			const id = document.getElementById('edit_id').value || null;
			const title = document.getElementById('edit_title').value.trim();
			const phone = document.getElementById('edit_phone').value.trim();
			const dateBR = document.getElementById('edit_date').value;
			const time = document.getElementById('edit_time').value;
			const endTime = document.getElementById('edit_end').value;
			const notes = document.getElementById('edit_notes').value;
			const type = document.getElementById('edit_type').value;
			const billing = document.getElementById('edit_billing').value;
			const insurer = (document.getElementById('edit_insurer').value || '').trim();
			const sendRemindersInput = document.getElementById('edit-send-reminders');
			const sendReminders = sendRemindersInput ? sendRemindersInput.checked : false;

			if (!id) {
				alert('Evento inválido.');
				return;
			}
			if (!title || !phone || !dateBR) {
				alert('Preencha o nome, telefone e a data.');
				return;
			}

			const startISO = buildLocalISO(dateBR, time);
			let endISO = endTime ? buildLocalISO(dateBR, endTime) : null;
			if (endISO) {
				const s = new Date(startISO);
				const e = new Date(endISO);
				if (!(e > s)) endISO = null;
			}

			const payload = { title, phone, start: startISO, end: endISO, notes, type, billing, insurer, send_reminders: type !== 'bloqueio' && sendReminders };

			try {
				const res = await fetch(`/api/events/${encodeURIComponent(id)}`, {
					method: 'PUT',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify(payload)
				});
				const result = await res.json();
				if (result.success) {
					closeModal('editModal');
					calendar?.refetchEvents();
					refreshAgendaSnapshot();
				} else {
					alert('Erro: ' + (result.error || 'Erro desconhecido'));
				}
			} catch (error) {
				alert('Falha de rede ao salvar. Tente novamente.');
			}
		}

		async function deleteEvent() {
			const id = document.getElementById('edit_id').value || null;
			if (!id) {
				alert('Evento inválido.');
				return;
			}
			if (!confirm('Deseja realmente excluir este agendamento?')) return;
			try {
				const res = await fetch(`/api/events/${encodeURIComponent(id)}`, { method: 'DELETE' });
				const result = await res.json();
				if (result.success) {
					closeModal('editModal');
					calendar?.refetchEvents();
					refreshAgendaSnapshot();
				} else {
					alert('Erro ao excluir: ' + (result.error || 'Erro desconhecido'));
				}
			} catch (error) {
				alert('Falha de rede ao excluir. Tente novamente.');
			}
		}

		function openWaitlistModal() {
			loadWaitlist();
			openModal('waitlistModal');
		}

		async function loadWaitlist() {
			const listEl = document.getElementById('wlItems');
			const emptyEl = document.getElementById('wlEmpty');
			if (!listEl || !emptyEl) return;
			listEl.innerHTML = '';
			listEl.appendChild(emptyEl);
			emptyEl.style.display = 'block';
			try {
				const res = await fetch('/api/waitlist');
				const data = await res.json();
				if (data && Array.isArray(data.items) && data.items.length) {
					emptyEl.style.display = 'none';
					for (const it of data.items) {
						const row = document.createElement('div');
						row.className = 'wl-item';
						row.innerHTML = `
							<div>
								<h4>${it.name || 'Sem nome'}</h4>
								<small>${it.billing || 'Particular'}${it.email ? ' • ' + it.email : ''}</small>
								<small>${[it.phone1, it.phone2].filter(Boolean).join(' • ')}</small>
								${it.notes ? `<small>${it.notes}</small>` : ''}
							</div>
							<div class="wl-actions">
								<button class="wl-btn" title="Remover" onclick="removeFromWaitlist('${it.id}')"><i class="fa fa-trash"></i></button>
							</div>`;
						listEl.appendChild(row);
					}
				}
			} catch (error) {
				// silencioso
			}
		}

		async function addToWaitlist() {
			const payload = {
				name: (document.getElementById('wl_patient').value || '').trim(),
				billing: document.getElementById('wl_billing').value,
				email: (document.getElementById('wl_email').value || '').trim(),
				phone1: (document.getElementById('wl_phone1').value || '').trim(),
				phone2: (document.getElementById('wl_phone2').value || '').trim(),
				notes: (document.getElementById('wl_notes').value || '').trim()
			};
			if (!payload.name) {
				alert('Informe o nome do paciente.');
				return;
			}
			try {
				const res = await fetch('/api/waitlist', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify(payload)
				});
				const data = await res.json();
				if (data.success) {
					document.getElementById('wl_patient').value = '';
					document.getElementById('wl_email').value = '';
					document.getElementById('wl_phone1').value = '';
					document.getElementById('wl_phone2').value = '';
					document.getElementById('wl_notes').value = '';
					loadWaitlist();
					refreshAgendaSnapshot();
				} else {
					alert('Erro ao adicionar: ' + (data.error || 'Erro desconhecido'));
				}
			} catch (error) {
				alert('Falha de rede ao adicionar.');
			}
		}

		async function removeFromWaitlist(id) {
			if (!id) return;
			if (!confirm('Remover paciente da lista de espera?')) return;
			try {
				const res = await fetch(`/api/waitlist/${encodeURIComponent(id)}`, { method: 'DELETE' });
				const data = await res.json();
				if (data.success) {
					loadWaitlist();
					refreshAgendaSnapshot();
				} else {
					alert('Não foi possível remover.');
				}
			} catch (error) {
				alert('Falha de rede ao remover.');
			}
		}

		async function refreshAgendaSnapshot() {
			try {
				const res = await fetch('/api/agenda_snapshot');
				if (!res.ok) return;
				const data = await res.json();
				updateSummaryCards(data.summary || {});
				updateUpcomingList(data.upcoming_events || []);
				updateTypeBreakdown(data.type_summary || []);
				updateWaitlistCard(data.waitlist_count ?? 0);
			} catch (error) {
				// silencioso
			}
		}

		function updateSummaryCards(summary) {
			const mapping = {
				today: summary.today_count ?? 0,
				week: summary.week_count ?? 0,
				returns: summary.returns_count ?? 0,
				blocked: summary.blocked_count ?? 0
			};
			Object.entries(mapping).forEach(([key, value]) => {
				const el = document.querySelector(`[data-summary="${key}"]`);
				if (el) el.textContent = value;
			});
			const upcoming = document.querySelector('[data-upcoming-count]');
			if (upcoming) upcoming.textContent = summary.upcoming_count ?? 0;
		}

		function updateUpcomingList(items) {
			const list = document.getElementById('upcomingList');
			if (!list) return;
			list.innerHTML = '';
			if (!items.length) {
				const li = document.createElement('li');
				li.className = 'empty-state';
				li.textContent = 'Nenhum agendamento futuro registrado.';
				list.appendChild(li);
			} else {
				items.forEach(item => {
					const li = document.createElement('li');
					const button = document.createElement('button');
					button.type = 'button';
					button.className = 'upcoming-item js-upcoming-item';
					if (item.id !== undefined) button.dataset.eventId = item.id;
					if (item.start_iso) button.dataset.eventStart = item.start_iso;
					if (item.type_slug) button.dataset.eventType = item.type_slug;
					button.innerHTML = `
						<span class="upcoming-time"><span class="weekday">${item.weekday || ''}</span><strong>${item.start_label || '--'}</strong></span>
						<span class="upcoming-body">
							<span class="upcoming-title">${item.title || 'Evento'}</span>
							<span class="upcoming-meta">${item.type_label || ''}${item.billing_label ? ' · ' + item.billing_label : ''}</span>
						</span>`;
					li.appendChild(button);
					list.appendChild(li);
				});
			}
			bindUpcomingQuickLinks();
		}

		function updateTypeBreakdown(items) {
			const list = document.getElementById('typeBreakdownList');
			if (!list) return;
			list.innerHTML = '';
			if (!items.length) {
				const li = document.createElement('li');
				li.className = 'empty-state';
				li.textContent = 'Ainda não há eventos suficientes para análise.';
				list.appendChild(li);
				return;
			}
			items.forEach(item => {
				const li = document.createElement('li');
				li.className = 'type-row';
				if (item.slug) li.dataset.type = item.slug;
				li.innerHTML = `
					<span class="type-label">${item.label || capitalize(item.slug || '')}</span>
					<div class="type-bar"><span class="type-bar-fill" style="width: ${(item.percent ?? 0)}%;"></span></div>
					<span class="type-meta">${item.count ?? 0} (${item.percent ?? 0}%)</span>`;
				list.appendChild(li);
			});
		}

		function updateWaitlistCard(count) {
			const el = document.querySelector('[data-waitlist-count]');
			if (el) el.textContent = count;
		}

		function capitalize(value) {
			if (!value) return '';
			const str = value.toString().toLowerCase();
			return str.charAt(0).toUpperCase() + str.slice(1);
		}
	</script>
</body>

</html>
