<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8">
    <title>Ponza Analyzer</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
  </head>
  <body>
    <main class="page">
      <section class="panel">
        <h1>Analise de Exames</h1>
        <p>Envie um PDF do laudo para extrair os dados e gerar uma prescricao inteligente.</p>
        <form method="post" enctype="multipart/form-data" class="upload-form">
          <label class="file-input">
            <span>Arquivo PDF</span>
            <input type="file" name="pdf_file" accept="application/pdf" required>
          </label>
          <button type="submit">Analisar</button>
        </form>
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            <ul class="flash-list">
              {% for category, message in messages %}
                <li class="flash {{ category }}">{{ message }}</li>
              {% endfor %}
            </ul>
          {% endif %}
        {% endwith %}
      </section>

      {% if extraction %}
        <section class="panel">
          <h2>Dados extraidos</h2>
          <p class="file-name">{{ file_name }}</p>
          <div class="grid">
            <div>
              <h3>Paciente</h3>
              <ul class="info-list">
                {% for key, value in extraction.patient.items() %}
                  {% if value %}
                    <li><strong>{{ key }}:</strong> {{ value }}</li>
                  {% endif %}
                {% endfor %}
              </ul>
            </div>
            <div>
              <h3>Notas do pipeline</h3>
              {% if extraction.suggestions %}
                <ul class="info-list">
                  {% for item in extraction.suggestions %}
                    <li>{{ item }}</li>
                  {% endfor %}
                </ul>
              {% else %}
                <p>Nenhuma sugestao automatica.</p>
              {% endif %}
            </div>
          </div>
          <div>
            <h3>Resultados laboratoriais</h3>
            {% if extraction.lab_results %}
              <table>
                <thead>
                  <tr>
                    <th>Exame</th>
                    <th>Valor</th>
                    <th>Referencia</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody>
              {% for result in extraction.lab_results %}
                <tr>
                  <td>{{ result.name or result.nome or result.test }}</td>
                  <td>{{ result.value or result.valor }}</td>
                  <td>{{ result.reference or result.referencia or '-' }}</td>
                  <td class="status {{ result.status }}">{{ result.status or result.estado or 'n/d' }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
            {% else %}
              <p>Nao encontramos resultados estruturados.</p>
            {% endif %}
          </div>
        </section>
      {% endif %}

      {% if ai_result %}
        <section class="panel">
          <h2>Prescricao Inteligente (IA)</h2>
          {% if ai_result.ok and ai_result.analysis %}
            {% set analysis = ai_result.analysis %}
            <div class="ai-block">
              <h3>Resumo clinico</h3>
              <p>{{ analysis.resumo_clinico }}</p>
            </div>
            {% if analysis.prescricao %}
              <div class="ai-block">
                <h3>Condutas</h3>
                <ul>
                  {% for item in analysis.prescricao %}
                    <li>{{ item }}</li>
                  {% endfor %}
                </ul>
              </div>
            {% endif %}
            {% if analysis.orientacoes %}
              <div class="ai-block">
                <h3>Orientacoes ao paciente</h3>
                <ul>
                  {% for item in analysis.orientacoes %}
                    <li>{{ item }}</li>
                  {% endfor %}
                </ul>
              </div>
            {% endif %}
            {% if analysis.alertas %}
              <div class="ai-block">
                <h3>Alertas</h3>
                <ul>
                  {% for item in analysis.alertas %}
                    <li>{{ item }}</li>
                  {% endfor %}
                </ul>
              </div>
            {% endif %}
          {% else %}
            <p class="error">{{ ai_result.error or 'Erro desconhecido' }}</p>
          {% endif %}
        </section>
      {% endif %}
    </main>
  </body>
</html>
